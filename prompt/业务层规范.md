# 业务层（Service）开发规范

## 核心原则

**Service 层负责所有查询逻辑和业务逻辑，每个 Service 类分为两大内容：条件查询和业务逻辑。**

## Service 类结构规范

### ✅ 标准模板

```java
package org.charno.system.service;

import org.charno.system.entity.EntityName;
import org.charno.system.repository.EntityRepository;
import org.springframework.data.domain.Pageable;
import org.springframework.data.r2dbc.core.R2dbcEntityTemplate;
import org.springframework.data.relational.core.query.Criteria;
import org.springframework.data.relational.core.query.Query;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

/**
 * 实体名称业务服务
 */
@Service
public class EntityService {

    private final R2dbcEntityTemplate template;
    private final EntityRepository repository;

    public EntityService(R2dbcEntityTemplate template, EntityRepository repository) {
        this.template = template;
        this.repository = repository;
    }

    // ==================== 条件查询 ====================

    /**
     * 不分页条件查询
     * 
     * @param param1 参数1（可选）
     * @param param2 参数2（可选）
     * @return Flux<EntityName> 实体列表
     */
    public Flux<EntityName> query(String param1, String param2) {
        Criteria criteria = buildCriteria(param1, param2);
        return template.select(EntityName.class)
            .matching(Query.query(criteria))
            .all();
    }

    /**
     * 分页条件查询
     * 
     * @param param1 参数1（可选）
     * @param param2 参数2（可选）
     * @param pageable 分页参数
     * @return Flux<EntityName> 实体列表
     */
    public Flux<EntityName> queryWithPage(String param1, String param2, Pageable pageable) {
        Criteria criteria = buildCriteria(param1, param2);
        return template.select(EntityName.class)
            .matching(Query.query(criteria).with(pageable))
            .all();
    }

    /**
     * 构建查询条件
     */
    private Criteria buildCriteria(String param1, String param2) {
        Criteria criteria = Criteria.empty();

        if (param1 != null && !param1.isEmpty()) {
            criteria = criteria.and(Criteria.where("field1").is(param1));
        }

        if (param2 != null && !param2.isEmpty()) {
            criteria = criteria.and(Criteria.where("field2").like("%" + param2 + "%"));
        }

        return criteria;
    }

    // ==================== 业务逻辑 ====================

    // TODO: 业务逻辑方法1
    // TODO: 业务逻辑方法2
    // TODO: 业务逻辑方法3

}
```

## 条件查询规范

### 1. 方法数量限制

**每个 Service 类只允许有两个查询方法：**
- `query()` - 不分页条件查询
- `queryWithPage()` - 分页条件查询

### 2. 查询条件规范

- **所有查询参数均为可选**：使用 `null` 或空字符串表示不应用该条件
- **动态构建查询条件**：使用 `buildCriteria()` 私有方法统一构建
- **支持模糊查询**：字符串字段使用 `like()` 方法，添加 `%` 通配符
- **精确查询**：数值、枚举等字段使用 `is()` 方法

### 3. 查询条件构建示例

```java
private Criteria buildCriteria(String status, Long roleId, String keyword) {
    Criteria criteria = Criteria.empty();

    // 精确匹配
    if (status != null && !status.isEmpty()) {
        criteria = criteria.and(Criteria.where("status").is(status));
    }

    // 数值匹配
    if (roleId != null) {
        criteria = criteria.and(Criteria.where("role_id").is(roleId));
    }

    // 模糊查询
    if (keyword != null && !keyword.isEmpty()) {
        criteria = criteria.and(Criteria.where("name").like("%" + keyword + "%"));
    }

    // 空值判断
    if (includeDeleted == false) {
        criteria = criteria.and(Criteria.where("deletedAt").isNull());
    }

    return criteria;
}
```

### 4. 字段名使用规范

- **使用 Java 字段名**：如 `accountType`、`accountIdentifier`
- **关联字段使用数据库列名**：如 `role_id`（通过 `@Column` 映射的字段）
- **避免硬编码**：考虑使用常量或配置

## 业务逻辑规范

### 1. 业务逻辑区域

**使用注释分隔业务逻辑区域：**

```java
// ==================== 业务逻辑 ====================

// TODO: 业务逻辑方法1
// TODO: 业务逻辑方法2
```

### 2. TODO 注释规范

- **使用 TODO 注释标记待实现的业务逻辑**
- **注释应清晰描述业务功能**
- **按优先级或功能模块组织 TODO**

### 3. 业务逻辑实现示例

```java
// ==================== 业务逻辑 ====================

/**
 * 创建实体
 */
public Mono<Entity> create(Entity entity) {
    // 业务验证
    // 数据处理
    // 调用 Repository 保存
    return repository.save(entity);
}

/**
 * 更新实体
 */
public Mono<Entity> update(Long id, Entity entity) {
    return repository.findById(id)
        .flatMap(existing -> {
            // 业务逻辑处理
            entity.setId(id);
            return repository.save(entity);
        });
}
```

## 依赖注入规范

### 必需依赖

```java
@Service
public class EntityService {
    // R2dbcEntityTemplate - 用于条件查询
    private final R2dbcEntityTemplate template;
    
    // Repository - 用于基础 CRUD 操作
    private final EntityRepository repository;
    
    public EntityService(R2dbcEntityTemplate template, EntityRepository repository) {
        this.template = template;
        this.repository = repository;
    }
}
```

## ❌ 禁止事项

1. **禁止超过两个查询方法**
   ```java
   // ❌ 错误：超过两个查询方法
   public Flux<Entity> query(...);
   public Flux<Entity> queryWithPage(...);
   public Flux<Entity> findByStatus(...); // 禁止
   ```

2. **禁止在查询方法中硬编码业务逻辑**
   ```java
   // ❌ 错误：查询方法中包含业务逻辑
   public Flux<Entity> query(...) {
       // 查询
       return result.filter(e -> e.getDeletedAt() == null); // 业务逻辑应在 buildCriteria 中
   }
   ```

3. **禁止在条件查询区域实现业务逻辑**
   ```java
   // ❌ 错误：业务逻辑不应放在条件查询区域
   // ==================== 条件查询 ====================
   public Mono<Entity> create(Entity entity) { // 错误位置
       return repository.save(entity);
   }
   ```

## ✅ 检查清单

- [ ] Service 类只有两个查询方法：`query()` 和 `queryWithPage()`
- [ ] 所有查询条件都是可选的
- [ ] 使用 `buildCriteria()` 私有方法构建查询条件
- [ ] 业务逻辑区域使用 TODO 注释标记
- [ ] 注入了 `R2dbcEntityTemplate` 和 `Repository`
- [ ] 查询方法使用 `R2dbcEntityTemplate` 实现
- [ ] 业务逻辑方法使用 `Repository` 实现

## 优势

1. **结构清晰**：条件查询和业务逻辑分离
2. **统一接口**：所有查询都通过两个方法完成
3. **灵活查询**：支持动态组合查询条件
4. **易于扩展**：业务逻辑区域便于添加新功能

