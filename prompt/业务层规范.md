# 业务层（Service）开发规范

## 核心原则

**Service 层分为两类：面向管理的业务服务（Admin前缀）负责条件查询，面向业务的业务服务负责业务逻辑。**

## Service 类分类

### 1. 面向管理的业务服务（Admin前缀）

**类名规范：** 类名需要加上 `Admin` 前缀，如 `AdminSysUserService`

**功能：** 仅提供条件查询功能（分页和不分页）

### 2. 面向业务的业务服务

**类名规范：** 按业务功能命名，如 `LoginService`、`RegisterService`、`PasswordService`

**功能：** 实现具体的业务逻辑

**注意：** 不应使用实体类名称命名，而应根据业务功能命名

## 面向管理的业务服务规范

### ✅ 标准模板

```java
package org.charno.system.service;

import org.charno.system.entity.EntityName;
import org.springframework.data.domain.Pageable;
import org.springframework.data.r2dbc.core.R2dbcEntityTemplate;
import org.springframework.data.relational.core.query.Criteria;
import org.springframework.data.relational.core.query.Query;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

/**
 * 实体名称管理业务服务
 * 面向管理的业务服务，提供条件查询功能
 */
@Service
public class AdminEntityService {

    private final R2dbcEntityTemplate template;

    public AdminEntityService(R2dbcEntityTemplate template) {
        this.template = template;
    }

    // ==================== 条件查询 ====================

    /**
     * 不分页条件查询
     * 
     * @param param1 参数1（可选）
     * @param param2 参数2（可选）
     * @return Flux<EntityName> 实体列表
     */
    public Flux<EntityName> query(String param1, String param2) {
        Criteria criteria = buildCriteria(param1, param2);
        return template.select(EntityName.class)
            .matching(Query.query(criteria))
            .all();
    }

    /**
     * 分页条件查询
     * 
     * @param param1 参数1（可选）
     * @param param2 参数2（可选）
     * @param pageable 分页参数
     * @return Flux<EntityName> 实体列表
     */
    public Flux<EntityName> queryWithPage(String param1, String param2, Pageable pageable) {
        Criteria criteria = buildCriteria(param1, param2);
        return template.select(EntityName.class)
            .matching(Query.query(criteria).with(pageable))
            .all();
    }

    /**
     * 构建查询条件
     */
    private Criteria buildCriteria(String param1, String param2) {
        Criteria criteria = Criteria.empty();

        if (param1 != null && !param1.isEmpty()) {
            criteria = criteria.and(Criteria.where("field1").is(param1));
        }

        if (param2 != null && !param2.isEmpty()) {
            criteria = criteria.and(Criteria.where("field2").like("%" + param2 + "%"));
        }

        return criteria;
    }
}
```

## 面向业务的业务服务规范

### ✅ 标准模板

```java
package org.charno.system.service;

import org.charno.system.entity.SysUser;
import org.charno.systementity.repository.SysUserRepository;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

/**
 * 登录业务服务
 * 面向业务的业务服务，实现具体的业务逻辑
 */
@Service
public class LoginService {

    private final SysUserRepository userRepository;

    public LoginService(SysUserRepository userRepository) {
        this.userRepository = userRepository;
    }

    // ==================== 业务逻辑 ====================

    /**
     * 用户登录
     */
    public Mono<SysUser> login(String accountType, String accountIdentifier, String password) {
        // TODO: 实现登录业务逻辑
        // 1. 根据账号类型和标识符查询用户
        // 2. 验证密码
        // 3. 更新登录时间和IP
        // 4. 返回用户信息
        return Mono.empty();
    }

    /**
     * 用户登出
     */
    public Mono<Void> logout(String userId) {
        // TODO: 实现登出业务逻辑
        return Mono.empty();
    }

}
```

## 条件查询规范（仅适用于Admin前缀的Service）

### 1. 方法数量限制

**每个 Admin 前缀的 Service 类只允许有两个查询方法：**
- `query()` - 不分页条件查询
- `queryWithPage()` - 分页条件查询

### 2. 查询条件规范

- **所有查询参数均为可选**：使用 `null` 或空字符串表示不应用该条件
- **动态构建查询条件**：使用 `buildCriteria()` 私有方法统一构建
- **支持模糊查询**：字符串字段使用 `like()` 方法，添加 `%` 通配符
- **精确查询**：数值、枚举等字段使用 `is()` 方法

### 3. 查询条件构建示例

```java
private Criteria buildCriteria(String status, Long roleId, String keyword) {
    Criteria criteria = Criteria.empty();

    // 精确匹配
    if (status != null && !status.isEmpty()) {
        criteria = criteria.and(Criteria.where("status").is(status));
    }

    // 数值匹配
    if (roleId != null) {
        criteria = criteria.and(Criteria.where("role_id").is(roleId));
    }

    // 模糊查询
    if (keyword != null && !keyword.isEmpty()) {
        criteria = criteria.and(Criteria.where("name").like("%" + keyword + "%"));
    }

    // 空值判断
    if (includeDeleted == false) {
        criteria = criteria.and(Criteria.where("deletedAt").isNull());
    }

    return criteria;
}
```

### 4. 字段名使用规范

- **使用 Java 字段名**：如 `accountType`、`accountIdentifier`
- **关联字段使用数据库列名**：如 `role_id`（通过 `@Column` 映射的字段）
- **避免硬编码**：考虑使用常量或配置

## 业务逻辑规范

### 1. 业务逻辑区域

**使用注释分隔业务逻辑区域：**

```java
// ==================== 业务逻辑 ====================

// TODO: 业务逻辑方法1
// TODO: 业务逻辑方法2
```

### 2. TODO 注释规范

- **使用 TODO 注释标记待实现的业务逻辑**
- **注释应清晰描述业务功能**
- **按优先级或功能模块组织 TODO**

### 3. 业务逻辑实现示例

```java
// ==================== 业务逻辑 ====================

/**
 * 用户登录
 */
public Mono<SysUser> login(String accountType, String accountIdentifier, String password) {
    // 1. 查询用户
    return userRepository.findByAccountTypeAndAccountIdentifier(accountType, accountIdentifier)
        .flatMap(user -> {
            // 2. 验证密码
            if (passwordEncoder.matches(password, user.getPasswordHash())) {
                // 3. 更新登录信息
                user.setLastLoginAt(OffsetDateTime.now());
                return userRepository.save(user);
            } else {
                return Mono.error(new RuntimeException("密码错误"));
            }
        });
}

/**
 * 用户注册
 */
public Mono<SysUser> register(SysUser user, String password) {
    // 1. 检查账号是否已存在
    // 2. 加密密码
    // 3. 设置默认值
    // 4. 保存用户
    return userRepository.save(user);
}
```

### 4. 业务服务命名示例

- `LoginService` - 登录相关业务逻辑
- `RegisterService` - 注册相关业务逻辑
- `PasswordService` - 密码相关业务逻辑（修改密码、重置密码等）
- `UserProfileService` - 用户资料相关业务逻辑
- `PermissionService` - 权限相关业务逻辑

## 依赖注入规范

### Admin 前缀的 Service（条件查询）

```java
@Service
public class AdminEntityService {
    // R2dbcEntityTemplate - 用于条件查询
    private final R2dbcEntityTemplate template;
    
    public AdminEntityService(R2dbcEntityTemplate template) {
        this.template = template;
    }
}
```

### 业务 Service（业务逻辑）

```java
@Service
public class LoginService {
    // Repository - 用于基础 CRUD 操作
    private final SysUserRepository userRepository;
    
    // 可以注入多个 Repository 或其他 Service
    private final SysRoleRepository roleRepository;
    
    public LoginService(SysUserRepository userRepository, SysRoleRepository roleRepository) {
        this.userRepository = userRepository;
        this.roleRepository = roleRepository;
    }
}
```

## ❌ 禁止事项

1. **Admin 前缀的 Service 禁止超过两个查询方法**
   ```java
   // ❌ 错误：超过两个查询方法
   public Flux<Entity> query(...);
   public Flux<Entity> queryWithPage(...);
   public Flux<Entity> findByStatus(...); // 禁止
   ```

2. **Admin 前缀的 Service 禁止包含业务逻辑**
   ```java
   // ❌ 错误：Admin Service 不应包含业务逻辑
   @Service
   public class AdminEntityService {
       public Mono<Entity> create(Entity entity) { // 业务逻辑应在业务Service中
           return repository.save(entity);
       }
   }
   ```

3. **业务 Service 禁止包含查询方法**
   ```java
   // ❌ 错误：业务Service不应包含查询方法
   @Service
   public class LoginService {
       public Flux<SysUser> query(...) { // 查询应在Admin Service中
           return template.select(...);
       }
   }
   ```

4. **业务 Service 禁止使用实体类名称命名**
   ```java
   // ❌ 错误：不应使用实体类名称
   @Service
   public class SysUserService { // 错误：应使用业务功能命名，如 LoginService
       // ...
   }
   
   // ✅ 正确：使用业务功能命名
   @Service
   public class LoginService {
       // ...
   }
   ```

5. **禁止在查询方法中硬编码业务逻辑**
   ```java
   // ❌ 错误：查询方法中包含业务逻辑
   public Flux<Entity> query(...) {
       return result.filter(e -> e.getDeletedAt() == null); // 业务逻辑应在 buildCriteria 中
   }
   ```

## ✅ 检查清单

### Admin 前缀的 Service（条件查询）
- [ ] 类名以 `Admin` 前缀开头
- [ ] 只有两个查询方法：`query()` 和 `queryWithPage()`
- [ ] 所有查询条件都是可选的
- [ ] 使用 `buildCriteria()` 私有方法构建查询条件
- [ ] 注入了 `R2dbcEntityTemplate`
- [ ] 不包含业务逻辑方法

### 业务 Service（业务逻辑）
- [ ] 类名不包含 `Admin` 前缀
- [ ] 类名按业务功能命名（如 `LoginService`），不使用实体类名称
- [ ] 只包含业务逻辑方法
- [ ] 不包含查询方法
- [ ] 注入了 `Repository` 或其他需要的依赖
- [ ] 业务逻辑区域使用 TODO 注释标记

## 优势

1. **职责分离**：查询逻辑和业务逻辑完全分离
2. **结构清晰**：Admin Service 负责查询，业务 Service 负责业务逻辑
3. **统一接口**：所有查询都通过两个方法完成
4. **灵活查询**：支持动态组合查询条件
5. **易于扩展**：业务逻辑区域便于添加新功能
6. **命名规范**：Admin 前缀清晰标识管理类服务

