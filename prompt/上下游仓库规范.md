# 上下游仓库规范

## 核心原则

**上游仓库维护系统核心模块，下游仓库基于上游仓库进行定制开发。下游仓库通过新建独立模块实现定制功能。**

## 仓库分类

### 1. 上游仓库（Upstream Repository）

**职责：** 维护系统核心模块，提供稳定的基础功能

**核心模块：**
- `backend-common-redis` - Redis 通用模块
- `backend-common-security` - 安全认证模块
- `backend-common-web` - Web 通用模块
- `backend-start` - 启动模块
- `backend-system` - 系统业务模块
- `backend-system-entity` - 系统实体模块
- `frontend-admin-panel-shadcn` - 前端管理面板（部分内容）

**维护原则：**
- 只维护核心通用功能
- 保持向后兼容性
- 不包含业务定制逻辑

### 2. 下游仓库（Downstream Repository）

**职责：** 基于上游仓库进行业务定制开发

**开发原则：**
- 通过新建独立模块实现定制功能
- 不直接修改上游核心模块
- 保持与上游仓库的兼容性

## 上下游判断方式

**判断标准：通过文件夹名称判断**

- **上游仓库**：文件夹名称为 `CharnoAdmin`
- **下游仓库**：文件夹名称不为 `CharnoAdmin`（通常为业务项目名称）

## 模块组织规范

### 上游仓库模块结构

```
上游仓库/
├── backend-common-redis/          # Redis 通用模块
├── backend-common-security/        # 安全认证模块
├── backend-common-web/             # Web 通用模块
├── backend-start/                  # 启动模块
├── backend-system/                 # 系统业务模块
├── backend-system-entity/          # 系统实体模块
├── frontend-admin-panel-shadcn/    # 前端管理面板
└── pom.xml                         # 父级 POM
```

### 下游仓库模块结构

```
下游仓库/
├── backend-common-redis/          # 从上游拉取（不修改）
├── backend-common-security/       # 从上游拉取（不修改）
├── backend-common-web/            # 从上游拉取（不修改）
├── backend-start/                 # 从上游拉取（可配置）
├── backend-system/                # 从上游拉取（不修改）
├── backend-system-entity/         # 从上游拉取（不修改）
├── frontend-admin-panel-shadcn/   # 从上游拉取（管理端，在其中新增定制内容）
│
├── backend-custom-{业务名}/       # 新建：按业务划分的定制模块
├── frontend-client-xxx/          # 新建：客户端前端（可选）
├── frontend-mobile-xxx/           # 新建：移动端前端（可选）
│
└── pom.xml                        # 父级 POM（包含上游和定制模块）
```

## 定制开发规范

### 1. 新建独立模块原则

**✅ 正确做法：**

```xml
<!-- 下游仓库 pom.xml -->
<modules>
    <!-- 上游核心模块 -->
    <module>backend-common-redis</module>
    <module>backend-common-security</module>
    <module>backend-common-web</module>
    <module>backend-start</module>
    <module>backend-system</module>
    <module>backend-system-entity</module>
    
    <!-- 定制模块（按业务划分） -->
    <module>backend-custom-order</module>
    <module>backend-custom-payment</module>
</modules>
```

**❌ 禁止做法：**

- 禁止直接修改上游核心模块的源代码
- 禁止在上游模块中新增定制类
- 禁止修改上游模块的包结构

### 2. 定制模块命名规范

**后端定制模块命名原则：**
- **按业务领域划分**：`backend-custom-{业务名}`
- **不单独创建实体模块**：实体类包含在对应的业务模块中
- **不单独创建功能模块**：功能实现包含在对应的业务模块中
- 每个业务模块包含完整的业务功能：实体、Repository、Service、Controller 等

**前端定制说明：**
- **管理端**：沿用 `frontend-admin-panel-shadcn`，不新建独立的管理前端模块
- **管理端定制**：在 `frontend-admin-panel-shadcn` 中新增页面、组件和功能
- **非管理端**：客户端、移动端等非管理端前端可以新建独立前端模块

**后端定制模块示例：**
```
backend-custom-order        # 订单业务模块（包含订单实体、Repository、Service、Controller）
backend-custom-payment      # 支付业务模块（包含支付实体、Repository、Service、Controller）
backend-custom-inventory    # 库存业务模块（包含库存实体、Repository、Service、Controller）
```

**模块内部结构示例：**
```
backend-custom-order/
├── src/main/java/org/charno/custom/order/
│   ├── entity/              # 订单实体类
│   ├── repository/          # 订单 Repository
│   ├── service/             # 订单 Service（Admin 和业务 Service）
│   └── controller/          # 订单 Controller（Admin 和业务 Controller）
└── pom.xml
```

**❌ 禁止的模块划分方式：**
```
backend-custom-entity       # ❌ 错误：不单独创建实体模块
backend-custom-repository    # ❌ 错误：不单独创建 Repository 模块
backend-custom-service      # ❌ 错误：不单独创建 Service 模块
backend-custom-controller   # ❌ 错误：不单独创建 Controller 模块
```

### 3. 依赖关系规范

**定制模块依赖上游模块：**

```xml
<!-- backend-custom-business/pom.xml -->
<dependencies>
    <!-- 依赖上游核心模块 -->
    <dependency>
        <groupId>org.charno</groupId>
        <artifactId>backend-common-security</artifactId>
        <version>${project.version}</version>
    </dependency>
    <dependency>
        <groupId>org.charno</groupId>
        <artifactId>backend-system-entity</artifactId>
        <version>${project.version}</version>
    </dependency>
    
    <!-- 其他依赖 -->
</dependencies>
```

**禁止反向依赖：**
- 上游模块不能依赖下游定制模块
- 保持依赖方向：下游 → 上游

## 前端定制规范

### 1. 前端模块组织

**前端模块分类：**

**管理端前端：**
- **沿用 `frontend-admin-panel-shadcn` 作为统一管理前端**
- **不新建独立的管理前端模块**
- 所有管理端功能在 `frontend-admin-panel-shadcn` 中实现

**非管理端前端：**
- **客户端前端**：可以新建独立前端模块，如 `frontend-client-web`、`frontend-client-h5` 等
- **移动端前端**：可以新建独立前端模块，如 `frontend-mobile-app`、`frontend-mobile-miniprogram` 等
- **其他端前端**：根据业务需要可以新建相应的前端模块

**上游前端模块：**
- `frontend-admin-panel-shadcn` - 基础管理面板框架

**下游前端定制：**

**管理端定制：**
- 在 `frontend-admin-panel-shadcn/src/pages/` 中新增定制页面
- 在 `frontend-admin-panel-shadcn/src/components/` 中新增定制组件
- 在 `frontend-admin-panel-shadcn/src/api/` 中新增定制 API 接口
- 扩展和复用上游提供的组件和工具

**非管理端定制：**
- 新建独立的前端模块实现客户端、移动端等功能
- 可以复用管理端的 API 接口和业务逻辑

### 2. 前端定制原则

**✅ 管理端正确做法：**
- 在 `frontend-admin-panel-shadcn` 中新增页面和组件
- 在 `src/pages/` 目录下按业务模块组织页面
- 在 `src/components/` 目录下新增可复用组件
- 扩展上游提供的组件（通过组合而非修改）
- 保持与上游 UI 风格和设计规范一致
- 复用上游提供的工具函数和 API 封装

**✅ 非管理端正确做法：**
- 可以新建独立的前端模块（客户端、移动端等）
- 使用合适的框架和技术栈（React、Vue、React Native、uni-app 等）
- 复用后端 API 接口和业务逻辑
- 保持与后端 API 的兼容性

**❌ 禁止做法：**
- 禁止新建独立的管理前端模块（管理端必须沿用 `frontend-admin-panel-shadcn`）
- 禁止修改上游核心组件源代码
- 禁止破坏上游组件的兼容性
- 禁止在 `frontend-admin-panel-shadcn` 外新建管理前端

### 3. 前端目录结构规范

**管理端目录结构：**
```
frontend-admin-panel-shadcn/      # 管理端（沿用，不新建）
├── src/
│   ├── pages/                    # 页面目录
│   │   ├── system/               # 系统管理页面（上游）
│   │   ├── custom-xxx/           # 定制业务页面（下游新增）
│   │   └── custom-yyy/           # 定制业务页面（下游新增）
│   ├── components/               # 组件目录
│   │   ├── ui/                   # UI 基础组件（上游）
│   │   └── custom/               # 定制业务组件（下游新增）
│   ├── api/                      # API 接口目录
│   │   ├── system.ts             # 系统 API（上游）
│   │   └── custom-xxx.ts         # 定制业务 API（下游新增）
│   ├── types/                    # 类型定义
│   ├── utils/                    # 工具函数
│   └── ...
└── ...
```

**非管理端目录结构示例：**
```
frontend-client-web/              # 客户端 Web 前端（新建）
├── src/
│   ├── pages/                    # 页面目录
│   ├── components/               # 组件目录
│   ├── api/                      # API 接口目录
│   └── ...
└── ...

frontend-mobile-app/               # 移动端 App（新建）
├── src/
│   ├── screens/                  # 页面目录
│   ├── components/               # 组件目录
│   ├── api/                      # API 接口目录
│   └── ...
└── ...
```

## 配置文件管理

### 1. 应用配置

**上游配置：**
- 核心模块的默认配置
- 通用配置模板

**下游配置：**
- 在 `backend-start` 中覆盖配置
- 新增定制配置模块

### 2. 配置覆盖原则

```properties
# backend-start/src/main/resources/application.properties

# 继承上游默认配置
# 覆盖定制配置
custom.business.enabled=true
custom.feature.xxx=value
```

## 测试规范

### 1. 上游模块测试

**测试要求：**
- 核心模块必须有完整测试
- 保持测试覆盖率
- 测试用例随代码更新

### 2. 下游定制测试

**测试要求：**
- 定制模块必须有测试
- 测试上游模块集成
- 验证定制功能正确性

## 文档规范

### 1. 上游仓库文档

**文档内容：**
- 核心模块 API 文档
- 使用指南

### 2. 下游仓库文档

**文档内容：**
- 定制功能说明
- 部署指南
- 定制模块文档

## ✅ 检查清单

### 上游仓库维护
- [ ] 核心模块保持向后兼容
- [ ] 测试用例通过
- [ ] 文档及时更新

### 下游仓库开发
- [ ] 后端定制功能按业务划分在独立模块中实现
- [ ] 未单独创建实体模块或功能模块
- [ ] 每个业务模块包含完整的业务功能（实体、Repository、Service、Controller）
- [ ] 管理端定制内容在 `frontend-admin-panel-shadcn` 中新增
- [ ] 未新建独立的管理前端模块
- [ ] 非管理端前端（客户端、移动端等）如需要可新建独立前端模块
- [ ] 未直接修改上游核心模块源代码
- [ ] 依赖关系正确配置

## 最佳实践

### 1. 模块隔离
- 严格区分核心模块和定制模块
- 通过依赖注入而非直接修改实现扩展
- 按业务领域划分定制模块，而非按技术层次划分

### 2. 测试验证
- 全面测试定制功能
- 确保定制功能正常工作

### 3. 文档维护
- 及时更新定制文档
- 记录定制开发决策

## 常见问题

### Q1: 如何判断功能应该放在上游还是下游？

**A:** 
- **上游**：通用功能、核心基础设施、可复用的业务组件
- **下游**：特定业务逻辑、定制化需求、项目特有功能

### Q2: 可以在下游修改上游模块的配置吗？

**A:**
- 可以通过配置文件覆盖
- 禁止修改上游模块的源代码
- 配置覆盖应在 `backend-start` 模块中

### Q3: 前端定制必须新建独立模块吗？

**A:**
- **管理端**：不需要新建，沿用 `frontend-admin-panel-shadcn` 作为统一管理前端
  - 在 `frontend-admin-panel-shadcn/src/pages/` 中新增定制页面
  - 在 `frontend-admin-panel-shadcn/src/components/` 中新增定制组件
  - 所有管理端功能统一在 `frontend-admin-panel-shadcn` 中实现
- **非管理端**：可以新建独立前端模块
  - 客户端前端：可以新建 `frontend-client-xxx` 等模块
  - 移动端前端：可以新建 `frontend-mobile-xxx` 等模块
  - 其他端前端：根据业务需要可以新建相应的前端模块

### Q4: 后端定制模块如何划分？可以单独创建实体模块吗？

**A:**
- **按业务领域划分**：每个业务领域创建一个模块，如 `backend-custom-order`、`backend-custom-payment`
- **不单独创建实体模块**：实体类包含在对应的业务模块中
- **不单独创建功能模块**：功能实现包含在对应的业务模块中
- **每个业务模块包含完整功能**：实体、Repository、Service、Controller 等都在同一模块中
- **示例**：`backend-custom-order` 模块包含订单相关的所有代码（entity、repository、service、controller）

## 总结

上下游仓库规范的核心是**保持核心模块的稳定性和通用性，通过独立模块实现后端定制开发，管理端在统一前端模块中新增定制内容，非管理端可新建独立前端模块**。遵循此规范可以：

1. **保持代码整洁**：核心模块和定制模块清晰分离，管理端前端统一管理
2. **便于维护**：核心模块统一维护，后端定制模块独立开发，管理端前端定制内容集中管理
3. **降低风险**：避免直接修改核心模块，减少冲突和问题
4. **提高效率**：复用核心功能，专注定制开发
5. **前端灵活**：管理端统一在 `frontend-admin-panel-shadcn` 中实现，非管理端可根据需要新建独立前端模块

